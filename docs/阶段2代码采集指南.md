# 阶段2：代码采集与预处理指南

## 概述

阶段2的主要任务是：
1. 从GitHub采集开源代码
2. 解析代码提取函数和类
3. 清洗和优化代码片段
4. 提取元数据（依赖、语言等）

## 已创建的核心模块

### 1. GitHub服务 (`app/services/github_service.py`)

功能：
- 搜索GitHub仓库
- 获取仓库文件列表
- 下载文件内容
- 处理API速率限制

### 2. 代码解析器 (`app/services/code_parser.py`)

功能：
- 使用tree-sitter解析代码
- 提取函数定义
- 提取类定义
- 支持Python、Java、C++

### 3. 代码清洗器 (`app/services/code_cleaner.py`)

功能：
- 过滤低质量代码（注释过多、过短等）
- 去除重复代码
- 提取依赖库
- 检查代码完整性

### 4. 采集脚本 (`scripts/collect_code.py`)

功能：
- 从指定仓库采集代码
- 自动解析和清洗
- 保存为JSON格式

## 使用方法

### 基本使用

```bash
# 激活conda环境
conda activate coderetrievr

# 从指定仓库采集代码
python scripts/collect_code.py owner/repo --language python

# 示例：采集FastAPI项目
python scripts/collect_code.py tiangolo/fastapi --language python

# 指定输出目录
python scripts/collect_code.py owner/repo --language python --output ./data/code_snippets
```

### 参数说明

- `repo`: 仓库名称，格式为 `owner/repo`（必需）
- `--language, -l`: 编程语言，可选值：python, java, cpp（默认：python）
- `--output, -o`: 输出目录（默认：`./data/code_snippets`）

### 输出格式

采集的代码片段会保存为JSON文件，格式如下：

```json
[
  {
    "name": "function_name",
    "code": "def function_name():\n    ...",
    "type": "function",
    "start_line": 10,
    "end_line": 25,
    "file_path": "path/to/file.py",
    "repo_url": "https://github.com/owner/repo",
    "repo_name": "owner/repo",
    "language": "python",
    "dependencies": ["os", "sys", "json"]
  }
]
```

## 代码示例

### 示例1：使用GitHub服务搜索仓库

```python
from app.services.github_service import get_github_service

github = get_github_service()

# 搜索Python项目
repos = github.search_repositories(
    query="machine learning",
    language="python",
    sort="stars",
    per_page=10
)

for repo in repos:
    print(f"{repo.full_name}: {repo.stargazers_count} stars")
```

### 示例2：解析代码提取函数

```python
from app.services.code_parser import get_code_parser

parser = get_code_parser()

code = """
def quick_sort(arr):
    if len(arr) <= 1:
        return arr
    pivot = arr[len(arr) // 2]
    left = [x for x in arr if x < pivot]
    middle = [x for x in arr if x == pivot]
    right = [x for x in arr if x > pivot]
    return quick_sort(left) + middle + quick_sort(right)
"""

functions = parser.extract_functions(code, "python")
for func in functions:
    print(f"函数名: {func['name']}")
    print(f"代码:\n{func['code']}")
```

### 示例3：清洗代码片段

```python
from app.services.code_cleaner import get_code_cleaner

cleaner = get_code_cleaner()

code = """
# 这是一个示例函数
def example():
    # 注释
    return True
"""

cleaned = cleaner.clean_code_snippet(code)
if cleaned:
    print("代码通过清洗")
    dependencies = cleaner.extract_dependencies(cleaned, "python")
    print(f"依赖: {dependencies}")
else:
    print("代码未通过清洗")
```

## 批量采集示例

### 采集多个仓库

创建脚本 `scripts/batch_collect.py`：

```python
import subprocess
import sys

repositories = [
    "tiangolo/fastapi",
    "pallets/flask",
    "django/django",
    # 添加更多仓库...
]

for repo in repositories:
    print(f"\n采集 {repo}...")
    result = subprocess.run(
        [sys.executable, "scripts/collect_code.py", repo, "--language", "python"],
        cwd=Path(__file__).parent.parent
    )
    if result.returncode != 0:
        print(f"采集 {repo} 失败")
```

## 注意事项

### 1. GitHub API速率限制

- 未认证：60请求/小时
- 认证后：5,000请求/小时
- 代码已实现自动速率限制处理

### 2. 文件大小限制

- 自动跳过大于1MB的文件
- 避免处理二进制文件

### 3. 代码质量过滤

- 最小行数：5行
- 最大行数：200行
- 注释比例：不超过50%

### 4. 依赖安装

确保已安装tree-sitter相关包：

```bash
pip install tree-sitter tree-sitter-python tree-sitter-java tree-sitter-cpp
```

## 下一步

采集完成后，可以：

1. **查看采集结果**：检查 `data/code_snippets/` 目录
2. **进入阶段3**：将代码片段向量化并存储到矢量数据库
3. **质量评估**：运行质量检查脚本

---

**文档版本**：v1.0  
**创建日期**：2024年  
**最后更新**：2024年

