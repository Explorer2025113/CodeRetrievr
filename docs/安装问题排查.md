# 安装问题排查指南

## 常见安装错误及解决方案

### 问题1：tree-sitter-python 版本冲突

**错误信息**：
```
ERROR: Could not find a version that satisfies the requirement tree-sitter-python==0.20.4
ERROR: No matching distribution found for tree-sitter-python==0.20.4
```

**原因**：
- `tree-sitter-python==0.20.4` 版本不存在
- 新版本的 `tree-sitter-python` (0.21.0+) 需要 Python 3.10 或更高版本
- 当前环境使用 Python 3.9

**解决方案A：升级Python版本（推荐）**

```bash
# 删除旧环境
conda deactivate
conda env remove -n coderetrievr

# 创建Python 3.10环境
conda create -n coderetrievr python=3.10 -y
conda activate coderetrievr

# 重新安装依赖
pip install -r requirements.txt
```

**解决方案B：使用兼容版本（临时方案）**

如果必须使用 Python 3.9，可以尝试：

```bash
# 先安装基础包
pip install tree-sitter

# 尝试安装不指定版本的tree-sitter-python
pip install tree-sitter-python --no-deps

# 或者跳过tree-sitter-python，使用其他代码解析方案
```

**解决方案C：修改requirements.txt**

编辑 `requirements.txt`，移除tree-sitter相关包的版本限制：

```txt
tree-sitter
tree-sitter-python  # 不指定版本，让pip自动选择
tree-sitter-java
tree-sitter-cpp
```

---

### 问题2：torch安装失败

**错误信息**：
```
ERROR: Could not find a version that satisfies the requirement torch==2.1.0
```

**解决方案**：

**使用conda安装（推荐）**：
```bash
conda install pytorch cpuonly -c pytorch -y
```

**或使用PyTorch官方源**：
```bash
pip install torch --index-url https://download.pytorch.org/whl/cpu
```

**或使用国内镜像**：
```bash
pip install torch -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

### 问题3：依赖冲突

**错误信息**：
```
ERROR: pip's dependency resolver does not currently take into account all the packages
```

**解决方案**：

1. **创建全新环境**：
```bash
conda deactivate
conda env remove -n coderetrievr
conda create -n coderetrievr python=3.10 -y
conda activate coderetrievr
pip install -r requirements.txt
```

2. **分步安装**：
```bash
# 先安装基础包
pip install fastapi uvicorn pydantic

# 再安装其他依赖
pip install -r requirements.txt
```

---

### 问题4：网络连接超时

**错误信息**：
```
ERROR: Could not install packages due to an EnvironmentError: HTTPSConnectionPool
```

**解决方案**：

**使用国内镜像源**：

```bash
# 临时使用
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 永久配置
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

**常用镜像源**：
- 清华大学：`https://pypi.tuna.tsinghua.edu.cn/simple`
- 阿里云：`https://mirrors.aliyun.com/pypi/simple/`
- 中科大：`https://pypi.mirrors.ustc.edu.cn/simple/`

---

### 问题5：权限错误

**错误信息**：
```
ERROR: Could not install packages due to an OSError: [Errno 13] Permission denied
```

**解决方案**：

1. **确保在虚拟环境中**：
```bash
conda activate coderetrievr
# 确认提示符显示 (coderetrievr)
```

2. **使用用户安装**：
```bash
pip install --user -r requirements.txt
```

3. **检查环境变量**：
```bash
which python  # 确认使用的是conda环境的python
```

---

## Python版本建议

### 推荐版本：Python 3.10+

**原因**：
- 更好的包兼容性
- tree-sitter-python 新版本支持
- 性能改进
- 更多第三方库支持

### 创建Python 3.10环境

```bash
# 使用conda
conda create -n coderetrievr python=3.10 -y
conda activate coderetrievr

# 或使用venv
python3.10 -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows
```

---

## 完整安装流程（推荐）

```bash
# 1. 创建Python 3.10环境
conda create -n coderetrievr python=3.10 -y

# 2. 激活环境
conda activate coderetrievr

# 3. 升级pip
python -m pip install --upgrade pip

# 4. 配置镜像源（可选，国内用户推荐）
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 5. 安装依赖
pip install -r requirements.txt

# 6. 如果torch安装失败，使用conda安装
conda install pytorch cpuonly -c pytorch -y

# 7. 验证安装
python scripts/check_environment.py
```

---

## 验证安装

运行环境检查脚本：

```bash
python scripts/check_environment.py
```

应该看到所有检查项都通过 ✅

---

## 获取帮助

如果以上方案都无法解决问题：

1. 检查Python版本：`python --version`
2. 检查pip版本：`pip --version`
3. 查看详细错误信息
4. 提交Issue到项目仓库，附上错误日志

---

**文档版本**：v1.0  
**创建日期**：2024年  
**最后更新**：2024年

